---

- name: "define connection parameters"
  set_fact:
    connection_parameters: &con_param
      hostname: "{{ oracle_hostname }}"      
      port: "{{ oracle_port }}"      
      service_name: "{{ oracle_service_name }}"      
      username: "{{ oracle_username }}"
      password: "{{ oracle_password }}"
      mode: "sysdba"
    cdb_name: "{{ oracle_service_name | split('.') | first  }}"
    pdb_name: "PDB37"
    domain_name: "{{ oracle_service_name.split('.', 1)[1] }}"

- name: 'Connection paramters - see or use integration_config.yml.template'
  debug:
    var: connection_parameters

- name: drop PDB
  oracle_pdb:
    <<: *con_param
    pdb_name: "{{ pdb_name }}"
    state: "absent"

- name: create PDB
  oracle_pdb:
    <<: *con_param
    pdb_name: "{{ pdb_name }}" 
    pdb_admin_username: pdbadmin
    pdb_admin_password: pdbpass
    state: "opened"    
    roles: dba
  register: _
  failed_when: _.failed or not _.changed

- name: grant sysdba to pdbadmin
  oracle_grant:
    <<: *con_param
    grantee: pdbadmin
    privileges:
      - "create session"
      - "sysdba"
    grant_mode: "append"
    container: "{{ pdb_name }}"
    state: present
  
- name: create u_foo user
  oracle_user:
    <<: *con_param
    service_name: "{{ pdb_name }}{{ '.' ~ domain_name if domain_name }}"
    username: pdbadmin
    password: pdbpass
    schema_name: "u_foo"
    schema_password: "bar"

- name: create r_foo role
  oracle_role:
    <<: *con_param
    service_name: "{{ pdb_name }}{{ '.' ~ domain_name if domain_name }}"    
    username: pdbadmin
    password: pdbpass
    mode: sysdba
    
    role: "r_foo"
...
