---

- name: "define connection parameters"
  set_fact:
    connection_parameters: &con_param
      hostname: "{{ oracle_hostname }}"
      port: "{{ oracle_port }}"
      service_name: "{{ oracle_service_name }}"
      username: "{{ oracle_username }}"
      password: "{{ oracle_password }}"
      dsn: "{{ oracle_dsn }}"
      mode: "{{ mode }}"
      oracle_home: "{{ oracle_home }}"

- name: Define objects and privileges for DBCENTER_CLIENTE
  set_fact:
    dbcenter_cliente_objects:      
      - { owner: "SYS", object: "V_$SESSION", privilege: "SELECT" }
      #- { owner: "SYS", object: "DBCENTER_FS_INSTANCIA", privilege: "SELECT" }
      #- { owner: "AUDSYS", object: "AUD$UNIFIED", privilege: "SELECT" }
      #- { owner: "AUDSYS", object: "UNIFIED_AUDIT_TRAIL", privilege: "SELECT" }
      #- { owner: "AUDSYS", object: "DBMS_AUDIT_MGMT", privilege: "EXECUTE" }
      #- { owner: "SYS", object: "DBA_AUDIT_MGMT_LAST_ARCH_TS", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$DATABASE", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_DATA_FILES", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_DB_LINKS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_HIST_SNAPSHOT", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_HIST_SQLSTAT", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_HIST_WR_CONTROL", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_JOBS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_OBJECTS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_PART_TABLES", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_PROFILES", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_ROLES", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_ROLE_PRIVS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_SEGMENTS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_STMT_AUDIT_OPTS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_TABLESPACES", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_TAB_PARTITIONS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_USERS", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$INSTANCE", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$PARAMETER", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$PGASTAT", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$SGA", privilege: "SELECT" }
      #- { owner: "VCS", object: "SYS_ALIVE", privilege: "SELECT" }
      #- { owner: "SYS", object: "USER$", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$MEMORY_DYNAMIC_COMPONENTS", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$SGA_DYNAMIC_COMPONENTS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_SCHEDULER_JOBS", privilege: "SELECT" }
      - { owner: "SYS", object: "DBA_REGISTRY", privilege: "SELECT" }
      - { owner: "SYS", object: "V_$CONTROLFILE", privilege: "SELECT" }
      
- name: "user u_foo tear down"
  oracle_user:
    <<: *con_param
    schema_name: "u_foo"
    state: "absent"
  register: _
  failed_when: _.failed
      
- name: "user u_foo creation with no password"
  oracle_user:
    <<: *con_param
    schema_name: "u_foo"
    authentication_type: "none"
    state: "present"
  register: _
  failed_when: _.failed

- name: Grant for DBCENTER_CLIENTE 1
  oracle_grant:
    <<: *con_param
    grantee: u_foo
    object_privs: " {{ item.privilege }}:{{ item.owner }}.{{ item.object }} "
  loop: "{{ dbcenter_cliente_objects }}"
  loop_control:
    label: "{{ item.owner }}.{{ item.object }}"
      
- name: Grant for DBCENTER_CLIENTE 2
  oracle_grant:
    <<: *con_param
    grantee: u_foo
    object_privs: " {{ item.privilege }}:{{ item.owner }}.{{ item.object }} "
  loop: "{{ dbcenter_cliente_objects }}"
  loop_control:
    label: "{{ item.owner }}.{{ item.object }}"
    
- name: reset user's privilege
  oracle_grant:
    <<: *con_param
    grantee: "u_foo"
    grant_mode: "exact"

- name: Grant for DBCENTER_CLIENTE 3
  oracle_grant:
    <<: *con_param
    grantee: u_foo
    grant_mode: "exact"
    object_privs:
      - "SELECT:V$SESSION"
      - "SELECT:AUDSYS.AUD$UNIFIED" # this object is not visible in ALL_OBEJCTS
      - "SELECT:AUDSYS.UNIFIED_AUDIT_TRAIL"
      - "EXECUTE:DBMS_AUDIT_MGMT"
      - "SELECT:DBA_AUDIT_MGMT_LAST_ARCH_TS"
      - "SELECT:V$DATABASE"
      - "SELECT:DBA_DATA_FILES"
      - "SELECT:DBA_DB_LINKS"
      - "SELECT:DBA_HIST_SNAPSHOT"
      - "SELECT:DBA_HIST_SQLSTAT"
      - "SELECT:DBA_HIST_WR_CONTROL"
      - "SELECT:DBA_JOBS"
      - "SELECT:DBA_OBJECTS"
      - "SELECT:DBA_PART_TABLES"
      - "SELECT:DBA_PROFILES"
      - "SELECT:DBA_ROLES"
      - "SELECT:DBA_ROLE_PRIVS"
      - "SELECT:DBA_SEGMENTS"
      - "SELECT:DBA_STMT_AUDIT_OPTS"
      - "SELECT:DBA_TABLESPACES"
      - "SELECT:DBA_TAB_PARTITIONS"
      - "SELECT:DBA_USERS"
      - "SELECT:V$INSTANCE"
      - "SELECT:V$PARAMETER"
      - "SELECT:SYS.V_$PGASTAT"
      - "SELECT:SYS.V_$SGA"
      - "SELECT:SYS.USER$"
      - "select:v$memory_dynamic_components"
      - "select:v$sga_dynamic_components"
